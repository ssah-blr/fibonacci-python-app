trigger:
- main  # Replace 'main' with your branch name if different

pool:
  name: 'mac-self'

variables:
- group: DockerCredentials  # Reference the variable group
- name: DOCKER_REGISTRY
  value: 'docker.io'
- name: DOCKER_REPO
  value: 'ssahblr/python-app'

steps:
# 1. Checkout code
- task: Checkout@1

# 2. Test variable values (for debugging purposes)
- script: |
    echo "Testing Variables:"
    echo "DOCKER_USERNAME: $(DOCKER_USERNAME)"
    echo "DOCKER_PASSWORD: (hidden)"
  displayName: "Test variable values"

# Log in to the Docker registry using the service connection
- task: Docker@2
  displayName: Log in to Docker registry
  inputs:
    containerRegistry: 'Docker-service-conn' # The name of your service connection
    command: 'login'

# 3. Build Docker image
- task: Docker@2
  displayName: "Build Docker image"
  inputs:
    command: build
    Dockerfile: Dockerfile
    tags: |
      $(DOCKER_REPO):$(Build.BuildId)

# 4. Push Docker image
- task: Docker@2
  displayName: "Push Docker image"
  inputs:
    command: push
    containerRegistry: 'Docker-service-conn'  # Use a variable for the registry
    repository: $(DOCKER_REPO)
    tags: |
      $(Build.BuildId)
    containerRegistryEndpoint: $(DOCKER_USERNAME):$(DOCKER_PASSWORD) # Direct authentication
